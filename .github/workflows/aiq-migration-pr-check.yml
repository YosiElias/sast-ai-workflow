on:
  pull_request:
    branches:
      - main

jobs:
  check-feature-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.base.ref == 'main' }}
    
    steps:
      - name: Log PR info
        run: |
          echo "‚úÖ Running companion‚ÄëPR check for PR #${{ github.event.pull_request.number }}"
          echo "   ‚Ä¢ Base branch: ${{ github.event.pull_request.base.ref }}"
          echo "   ‚Ä¢ Head branch: ${{ github.event.pull_request.head.ref }}"
          echo "‚ö†Ô∏è  Check may reuse logs from a previous run on same commit (diff branch)."
          echo "If so, rerun the check after submitting PR to aiq-workflow-migration."

      - name: Check for matching AIQ PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr      = context.payload.pull_request;
            console.log(`üîç Looking for companion PR into 'aiq-workflow-migration' from '${pr.head.ref}'`);
            const { data: companions } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "all",
              base: "aiq-workflow-migration",
              head: `${context.repo.owner}:${pr.head.ref}`,
            });
            console.log(`   ‚Ä¢ Found ${companions.length} companion PR(s)`);
            if (!companions.length) {
              core.setFailed(`‚ùå No companion PR into 'aiq-workflow-migration' from branch '${pr.head.ref}'.`);
            } else {
              console.log(`‚úÖ Companion PR #${companions[0].number} found: ${companions[0].html_url}`);
            }